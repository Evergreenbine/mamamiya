<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="app.vo.Milk">

<!--    条件查询带rate语句，不过不用了，要改动的地方太多
select m.gid,gname,if(u.rate != null,0,u.rate) rate from milk m left join (select gid,rate,count(rate) from  goodsrate group by rate limit 1) u
on m.gid = u.gid
-->
<!--    查询商品的分类-->
    <select id="selectGoodCata" resultType="map">
        select * from gcata
    </select>

<!--根据gid查询特定的商品-->
    <select id="querygood" parameterType="int" resultType="app.vo.Milk">
        select * from milk where gid = #{gid}
    </select>

    <select id="list" parameterType="map" resultType="app.vo.Milk">
        select * from milk m,brand b where m.bid = b.bid and  m.tag = 1 and b.tag = 1
--        根据品牌查询
        <if test="bid != null">
            and b.bid = #{bid}
        </if>
--         查询具体商品
        <if test="gid != null and gid != ''">
            and m.gid = #{gid}
        </if>
        <if test="stage != null">
            and stage = #{stage}
        </if>
        <if test="cata != null">
            and cata = #{cata}
        </if>
        <if test="age != null">
            and age = #{age}
        </if>
        <if test="sprice != null and  eprice">
            and price between #{sprice} and #{eprice}
        </if>
    </select>

<!--查询商品评分-->
    <select id="queryrate" parameterType="int" resultType="map">
       select gid,rate,count(rate) from  goodsrate where gid = #{gid} group by rate order by count(rate) desc limit 1
    </select>

<!--找出每个用户中按时间和评分排序的 评论-->
    <select id="querygg" resultType="map">
       select m.gname,m.recommend,m.img,b.bname,b.bid,s.* from (select * from (select *,row_number() over (partition by useraccount order by createtime,rate desc) "oid"from commentgood) u group by useraccount) s,milk m,brand b
where s.gid = m.gid and b.bid = m.bid limit 3
    </select>

<!--    好评商品-->
    <select id="goodmilk" resultType="app.vo.Milk">
      select q.*, b.bname
from (select m.age,
             m.recommend,
             m.img,
             m.price,
             m.bid,
             m.gid,
             gname,
             if(u.rate is null, 0, u.rate) rate
      from milk m
               left join (select * from (select gid, rate, count(rate) from goodsrate group by gid,rate order by count(rate) desc ) u group by gid) u
                         on m.gid = u.gid
      where m.tag = 1 and m.gcid = 1) q,
     brand b
where q.bid = b.bid
  and b.tag = 1
order by q.rate desc
limit 8;
    </select>

<!--    新品商品-->
    <select id="latestgood" resultType="app.vo.Milk">
        select * from milk order by createtime desc limit 8;
    </select>

<!--    热销商品-->
    <select id="mostgood" resultType="app.vo.Milk">
       select b.bid,b.bname,m.*,count(r.useraccount) from recordgood r, brand b,milk m where m.bid = b.bid and r.gid =m.gid group by r.gid order by count(useraccount) desc limit 8
    </select>

<!--    根据gid查询具体的商品-->
    <select id="queryid" parameterType="int" resultType="app.vo.Milk">
        select * from where gid = #{gid}
    </select>

<!--    根据gid查询商品的评分-->
    <select id="queryreate" parameterType="int" resultType="int">
         select gid,rate,count(rate) from  goodsrate where gid = #{gid} group by rate order by count(rate) desc limit 1
    </select>

<!--    根据商品结账******-->
<!--  1.查询账户余额-->
    <select id="querymonney" parameterType="int" resultType="double">
        select monney from user where useraccount = #{useraccount} and tag = 1
    </select>
<!--    查库存-->
    <select id="querystore" parameterType="int" resultType="int">
        select store from milk where gid = #{gid}
    </select>
<!--  2.减金额，减库存-->
    <update id="purchase" parameterType="map" >
        update milk set store = store - #{count} where  gid = #{gid}
    </update>
    <update id="demoney" parameterType="map">
        update user set monney = monney - #{monney} where useraccount = #{useraccount}
    </update>
<!--    插入订单表-->
<insert id="createorder" parameterType="map">
    insert into shoporder(orderid, otime) value (#{orderid},#{otime})
</insert>
<!--    插入购买记录表-->
    <insert id="newpurchaserecord" parameterType="map">
        insert into recordgood(gid, useraccount,orderid)
        value (#{gid},#{useraccount},#{orderid})
    </insert>
<!--    根据商品结账 /////-->

<!--查询我的购买记录-->
    <select id="queryrecord" parameterType="int" resultType="java.util.Map">
       select
            b.bname,b.bid,m.gname,m.img, r.*,count(r.gid) "nums"
       from
            recordgood r, milk m, brand b
       where
            r.gid = m.gid and m.bid = b.bid and
        useraccount = #{useraccont} group by orderid, r.gid;
    </select>

<!--    根据用户id查询购买订单的总数-->
    <select id="querytotal" parameterType="int" resultType="int">
        select count(1) from (select *  from recordgood r where r.useraccount = #{useraccount} group by orderid, r.gid) u
    </select>

<!--   根据gid 查询所有商品评论-->
    <select id="querycomment" parameterType="int" resultType="java.util.Map">
        select * from commentgood g,user u where g.useraccount = u.useraccount
         <if test="gid != null">
             and gid = #{gid}
         </if>

    </select>


<!--    特别说明一下，goodsrate 和 commentgood 的评分数据其实是同步的，因为只有这么一个地方插入，新建多一个goodsrate
是为了统计，因为有些模块统计评分时是不需要那么多信息的，即不用关心是谁评论的，但有些事需要
-->
<!--    评价商品-->
    <insert id="commentgood" parameterType="app.vo.CommentGood">
        insert into commentgood( gid, useraccount, content, createtime,rate)
        value (#{gid},#{useraccount},#{content},#{createtime},#{rate})
    </insert>
<!--    商品评分-->
    <insert id="rategood" parameterType="app.vo.CommentGood">
        insert into goodsrate(gid,rate) value (#{gid},#{rate})
    </insert>
</mapper>